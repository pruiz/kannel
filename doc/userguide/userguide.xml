<?xml version="1.0" encoding="ISO-8859-1"?>

<!--
<!DOCTYPE book PUBLIC "-//Norman Walsh//DTD DocBk XML V3.1//EN"
     "dtd/docbook-xml/docbookx.dtd" [
<!ENTITY figtype "#FIGTYPE#">
<!ENTITY timestamp "#DATE#">
]>
-->

<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook V3.1//EN"
     [
<!ENTITY figtype "#FIGTYPE#">
<!ENTITY timestamp "#DATE#">
<!ENTITY version "#VERSION#">
]>

<book>

<bookinfo>
	<title>Kannel &version; User's Guide</title>
	<subtitle>Open Source WAP and SMS gateway</subtitle>
	<author>
		<firstname>Lars</firstname>
		<surname>Wirzenius</surname>
		<affiliation>
			<jobtitle>Gateway architect</jobtitle>
			<orgname>WapIT Ltd</orgname>
			<address> <email>liw@wapit.com</email>
			<otheraddr>http://www.wapit.com</otheraddr>
			<otheraddr>http://www.kannel.org</otheraddr>
			</address>
		</affiliation>
	</author>
	<abstract>
		<title>Abstract</title> 
		<para>This document describes how
		to install and use Kannel, the Open Source WAP and SMS Gateway
		produced by WapIT Ltd.
		</para>
	</abstract>
</bookinfo>


<chapter>
<title>Introduction</title>

	<highlights>
	<para>This chapter introduces WAP in general terms, and explains the
	role of the gateway in WAP, outlining its duties and features. It
	also explains why the Kannel project was started in the first place,
	and why it is open source.</para>
	</highlights>
	
	<para>With hundreds of millions of mobile phones in use all over the
	world, the market for services targeted at mobile users
	is mindbogglingly immense.  Even simple services find plenty of users,
	as long as they're useful or fun. Being able to get news, send e-mail
	or just be entertained wherever you are is extremely attractive to
	lots of people.</para>

	<para>The hottest technology for implementing mobile services is WAP,
	short for Wireless Application Protocol. It lets the phone act
	as a simple web browser, but optimizes the markup language,
	scripting language, and the transmission protocols for wireless
	use. The optimized protocols are translated to plain old HTTP by
	a <emphasis>WAP gateway</emphasis>.</para>

	<para>Kannel is an open source WAP gateway. It attempts to
	provide this essential part of the WAP infrastructure freely
	to everyone so that the market potential for WAP services,
	both from wireless operators and specialized service providers,
	will be realized as efficiently as possible.</para>

	<para>Kannel also works as an SMS gateway for GSM networks. Almost
	all GSM phones can send and receive SMS messages, so this is
	a way to serve many more clients than just those using a new
	WAP phone.</para>

	<para><ulink url="http://www.opensource.org">Open Source</ulink>
	is a way to formalize the principle of openness by placing the
	source code of a product under a Open Source compliant software
	license. The BSD license was chosen over other Open Source
	licenses by the merit of placing the least amount of limitations
	on what a third party is able to do with the source code. In
	practice this means that Kannel is going to be a fully-featured
	WAP implementation and compatible with a maximum amount of
	bearers with special emphasis on SMSC compatibility.</para>

	<para>The Kannel project was founded by <ulink
	url="http://www.wapit.com">WapIT Ltd.</ulink> in June, 1999. WapIT
	Ltd. was founded on October 6th 1998 in Helsinki, Finland to
	organize the work of the team which had built the most extensive
	set of SMS services so far. WapIT Ltd. acts as a content innovator
	and a packager for wireless services. WapIT is a member of the
	<ulink url="http://www.wapforum.org">WAP Forum</ulink>.</para>
	
	
<sect1>
<title>Overview of WAP</title>

	<para>WAP, short for Wireless Application Protocol, is a
	collection of languages and tools and an infrastructure for
	implementing services for mobile phones. Traditionally such
	services have worked via normal phone calls or short textual
	messages (e.g., SMS messages in GSM networks). Neither are very
	efficient to use, nor very user friendly.  WAP makes it possible
	to implement services similar to the World Wide Web.</para>
	
	<para>Unlike marketers claim, WAP does not bring the existing
	content of the Internet directly to the phone. There are too many
	technical and other problems for this to ever work properly. The
	main problem is that Internet content is mainly in the form of
	HTML pages, and they are written in such a way as to require
	fast connections, fast processors, large memories, big screens,
	audio output, and may require fairly efficient input mechanisms.
	That's OK, since they hopefully work better for traditional
	computers and networks that way. However, portable phones have
	very slow processors, very little memory, abysmal and intermittent
	bandwidth, and extremely awkward input mechanisms. Most existing
	HTML pages simply will not work on them, nor will they ever
	do that.</para>
	
	<para>WAP defines a completely new markup language, the Wireless
	Markup Language (WML), which is simpler and much more strictly
	defined than HTML.  It also defines a scripting language,
	WMLScript, which all browsers are required to support. To make
	things even simpler for the phones, it even defines its own
	bitmap format (Wireless Bitmap, or WBMP).</para>
	
	<para>HTTP is also too inefficient for wireless use. By using
	a semantically equivalent, but binary and compressed format it
	is possible to reduce the protocol overhead to a few bytes per
	request, instead of up to hundreds of bytes. Thus, WAP defines a
	new protocol stack to be used. However, to make things simpler
	also for the people actually implementing the services, WAP
	introduces a gateway between the phones and the servers providing
	content to the phones.</para>

        <figure>
        <title>Logcial position of WAP gateway between phone and content server.</title>
        <graphic fileref="wap-gateway&figtype;"></graphic>
        </figure>

	<para>The WAP gateway talks to the phone using the WAP protocol
	stack, and translates the requests it receives to normal
	HTTP. Thus, the content providers can use any HTTP servers, and
	can utilize existing know-how about HTTP service implementation
	and administration.</para>
	
	<para>In addition to protocol translations, the gateway
	also compresses the WML pages into a more compact form, to
	save bandwidth on the air and to further reduce the phone's
	processing requirements. It also compiles WMLScript programs
	into a bytecode format.</para>
	
	<para>Kannel is not just a WAP gateway. It also works as an
	SMS gateway.  Although WAP is the hot and technically superior
	technology, SMS phones exist in huge numbers and SMS services are
	thus quite useful.  Therefore, Kannel functions simultaneously
	as both a WAP and an SMS gateway.</para>

</sect1>
	
	
<sect1>
<title>Features</title>

	<para>This section needs to be written.</para>

</sect1>

<sect1>
<title>Requirements</title>

	<para>Kannel is being developed on Linux systems (Red Hat 6.1 and
	Debian potato), and should be fairly easy to port to other Unix-like
	systems. However, we don't yet support other platforms, due to lack
	of time. Kannel requires the following software environment:
	
	<itemizedlist>

	<listitem><para>C compiler and development libraries and related
	tools.</para></listitem>

	<listitem><para>The Gnome XML library (known as
	gnome-xml and libxml), version 1.8.1 or newer. See <ulink
	url="http://xmlsoft.org/xml.html">http://xmlsoft.org/xml.html</ulink>.
	</para></listitem>

	<listitem><para>GNU Make.</para></listitem>

	<listitem><para>Posix threads (pthread.h).</para></listitem>

	<listitem><para>GNU Bison 1.28 if you modify the WMLScript
	compiler.</para></listitem>

	<listitem><para>DocBook markup language tools (jade, jadetex,
	DocBook stylesheets, etc; see README.docbook), if you want
	to format the documentation (pre-formatted versions are
	available).</para></listitem>

	</itemizedlist>
	</para>
	
	<para>Hardware requirements are fluffier. We haven't benchmarked Kannel
	yet, so there are no hard numbers, but a reasonably fast PC workstation
	(400 MHz Pentium II, 128 MB RAM) should serve several concurrent
	users without problems. The goal is to support hundreds of concurrent
	users on that kind of hardware.</para>

</sect1>

</chapter>

<chapter>
<title>Installing the gateway</title>

	<para>This chapter explains how the gateway can be installed,
	either from a source code package or by using a pre-compiled
	binary version. The goal of this chapter is to get the gateway
	compiled and all the files in the correct places; the next
	chapter will explain how the gateway is configured.</para>

<sect1>
<title>Getting the source code</title>

	<para>The source code to
	Kannel is available for download at <ulink
	url="http://www.kannel.org/download.shtml">http://www.kannel.org/download.shtml</ulink>.
	It is available on various formats and you can choose to download
	either the latest release version or the daily snapshot of the
	development source tree for the next release version, depending
	on whether you want to use Kannel for production use or to
	participate in development.</para>
	
	<para>If you're serious about development, you probably want to
	use CVS, the version control system used by the Kannel project.
	This allows you to participate in Kannel development much
	more easily than by downloading the current daily snapshot and
	integrating any changes you've made every day. CVS does that
	for you. (See the Kannel web site for more information on how
	to use CVS.)</para>

</sect1>


<sect1>
<title>Finding the documentation</title>

	<para>The documentation for Kannel consists of three parts:
	
	<orderedlist>
	<listitem><para><citetitle>User's Guide</citetitle>, i.e., the one
		you're reading at the moment.</para></listitem>
	<listitem><para><citetitle>Architecture and 
		Design</citetitle>, in <filename>doc/arch</filename> or
		at <ulink url="http://www.kannel.org/arch.shtml">
		http://www.kannel.org/arch.shtml</ulink></para></listitem>
	<listitem><para>The <filename>README</filename> and various other
		random text files in the source tree.</para></listitem>
	</orderedlist>
	
	The goal is that everything you need to install and use Kannel
	is in <citetitle>User's Guide</citetitle>, but that goal is
	very far still. Similarly, the <citetitle>Architecture and
	Design</citetitle> document should tell you everything you need
	to know to dive into the sources and quickly be able to make
	your own modifications. It's not a replacement for actually
	reading the source code, but it should work as a map to the
	source code.  The <filename>README</filename> is not supposed
	to be very important, nor contain much information. Instead,
	it will just point at the other documentation.
	</para>
	
	<para>You need the following tools to compile Kannel:
	
	<itemizedlist>

	<listitem><para>C compiler and libraries for ANSI C, with normal
	Unix extensions such as BSD sockets.</para></listitem>

	<listitem><para>An implementation of POSIX threads
	(<filename>pthread.h</filename>).</para></listitem>

	<listitem><para>GNU Bison 1.28, if you want to modify the WMLScript
	compiler (a pre-generated parser is included for those who just
	want to compile Kannel).</para></listitem>

	<listitem><para>DocBook processing tools: DocBook stylesheets,
	jade, jadetex, etc; see <filename>README.docbook</filename> for
	more information (pre-formatted versions of the documentation
	are available, and you can compile Kannel itself even without
	the documentation tools).</para></listitem>
	
	<listitem><para>GNU autoconf, if you want to modify the
	configuration script.</para></listitem>

	</itemizedlist>
	
	</para>

</sect1>

<sect1>
<title>Compiling the gateway</title>

	<para>If you are using Kannel on a supported platform, or one
	that is similar enough to one, compiling Kannel is trivial.
	After you have unpacked the source package of your choosing,
	or after you have checked out the source code from CVS, enter
	the following commands:
	
<screen><userinput>./configure</userinput>
<userinput>make</userinput></screen>
	
	The <filename>configure</filename> script investigates your
	computer for various things Kannel compilation needs, and
	writes out the <filename>Makefile</filename> used to compile
	Kannel. <command>make</command> then runs the commands to
	actually compile Kannel.</para>
	
	<para>If either command writes out an error message and stops
	before it finishes its job, you have a problem, and you either
	need the expertese to fix it yourself, or you need to report the
	problem to the Kannel project. See <xref linkend="bug-reporting">
	for details.</para>
	
	<para>For detailed instruction to using the configuration
	script, see file <filename>INSTALL</filename>.</para>

</sect1>

<sect1>
<title>Installing the gateway</title>

	<para>After you have compiled Kannel, you need to install
	certain programs in a suitable place. This is most easily
	done by using <command>make</command> again:
	
<screen><userinput>make bindir=<replaceable>/path/to/directory</replaceable> install</userinput></screen>

	Replace <replaceable>/path/to/directory</replaceable> with the
	pathname of the actual directory where the programs should be
	installed. The programs that are installed are (as filenames
	from the root of the source directory):
	
	<simplelist>
	<member><filename>gw/bearerbox</filename></member>
	<member><filename>gw/smsbox</filename></member>
	<member><filename>gw/wapbox</filename></member>
	<member><filename>test/test_wml</filename></member>
	</simplelist>
	
	The filenames will get the version number of the gateway added
	during installation. This makes it easier to keep several
	versions installed, and lets you easily go back to an older
	version if the new version proves problematic.</para>
	
	<para>Kannel consists of three programs, called boxes: the
	bearer box is the interface towards the phones. It accepts
	WAP and SMS messages from the phones and sends them to the
	other boxes. The SMS box handles SMS gateway functionality,
	and the WAP box handles WAP gateway functionality. There can
	be several SMS boxes and several WAP boxes running, and they
	don't have to run all on the same host. This makes it possible
	to handle much larger loads than one host can handle.</para>

</sect1>

<sect1>
<title>Using pre-compiled binary packages</title>

	<para>Pre-compiled binary packages are not yet available,
	sorry.</para>

</sect1>

</chapter>

<chapter>
<title>Using the gateway</title>

	<para>This chapter explains how the gateway configured and used.
	It covers configuration file, keeping an eye on the gateway
	while it is running, and using the HTTP interface to control
	the gateway or using it for sending SMS messages.</para>

	<para>There is only one configuration file for all parts of
	Kalle, although when kannel is distributed to several hosts
	some lines from the configuration file can be removed in some
	hosts.</para>

<sect1>
<title>Configuration file syntax</title>

	<para>A configuration file consists of groups of configuration variables. Groups are
	separated by empty lines, and each variable is defined on its
	own line. Each group in Kannel configuration is distinguished
	with a group variable. Comments are lines that begin with a number sign
	(<literal>#</literal>) and are ignored (they don't, for example,
	separate groups of variables).</para>
	
	<para>A variable definition line has the name of the variable,
	and equals sign (<literal>=</literal>) and the value of the
	variable. The name of the variable can contain any characters
	except whitespace and equals. The value of the variable is a
	string, with or without quotation marks (<literal>"</literal>)
	around it. Quotation marks are needed if the variable needs to
	begin or end with whitespace or contain special characters.
	Inside quotation marks normal C escape character syntax works.</para>
	
	<para>Perhaps an example will make things easier to comprehend:

<programlisting>
1  # A do-nothing service.
2  group = sms-service
3  keyword = nop
4  text = "You asked nothing and I did it!"
5
6  # Default service.
4  group = sms-service
8  keyword = default
9  text = "No services defined"
</programlisting>

	The above snippet defines the keyword <literal>nop</literal>
	for an SMS service, and a default action for situation when
	the keyword in the SMS message does not match any defined
	service.</para>
	
	<para>Lines 1 and 6 are comment lines. Line 5 separates the
	two groups. The remaining lines define variables. The
	group type is defined by the group variable value.</para>
	
	<para>The various variables that are understood in each type
	of configuration group are explained below.</para>

</sect1>

<sect1>
<title>Configuring the gateway</title>

	<para>The configuration file consists of three parts:
	bearerbox configurations, smsbox configurations and
	wapbox configurations. Bearerbox part has one 'core' group
	and any used SMS center groups, while wapbox part has only
	one wapbox group. In smsbox part there is one smsbox group and
	then number of sms-service and sendsms-user groups.</para>

	<para>Details of all those groups are in file 
	<filename>newconf.txt</filename> in userguide directory.</para>

<programlisting>
</programlisting>

</sect1>

<sect1>
<title>Starting the gateway</title>

	<para>To start the gateway, you need to start each box you need.
	You always need the bearer box, and depending on whether you want
	WAP and SMS gateways you need to start the WAP and SMS boxes. If
	you want, you can run several of them, but we'll explain the
	simple case of only running one each.</para>
	
	<para>There is currently no sophisticated way to start the boxes.
	Instead, you run them from the command line. This means that you
	probably want to have one terminal window for each box you want
	to start (xterm or screen will do fine). To start the bearer
	box, give the following command:

<screen><userinput>./bearerbox -v 1 my_conf.conf</userinput></screen>

	The <option>-v 1</option> sets the logging level to
	<literal>INFO</literal>. This way, you won't see a large amount of
	debugging output (the default is <literal>DEBUG</literal>).</para>
	
	<para>After the bearer box, you can start the WAP box:
	
<screen><userinput>./wapbox -v 1 my_conf.conf</userinput></screen>

	or the SMS box:

<screen><userinput>./smsbox -v 1 my_conf.conf</userinput></screen>

	or both, of course. The order does not matter, except that you
	need to start the bearer box before the other boxes. Without
	the bearer box, the other boxes won't even start.</para>
	
	<para>The 'gw.conf' above is a name of the configuration
	file. For fast startup, Kannel is supplied with two trivial
	simple configuration files, <literal>smskannel.conf</literal>
	and <literal>wapkannel.conf</literal>. The first one is for
	testing out the SMS side, and it requires, in addition to
	running bearerbox and smsbox, to start first the
	<literal>fakesmsc</literal> program from utils
	directory. The second one is for WAP use, and it requires a
	running bearerbox and wapbox.</para>
	
</sect1>

<sect1>
<title>Using the HTTP interface to send SMS messages</title>

	<para>If you have configured Kannel to allow the sendsms
	service, you can send SMS messages via HTTP, e.g., using a
	WWW browser. The URL looks like this:
	
<programlisting>
http://smsbox.host.name:port/cgi-bin/sendsms?username=username&amp;
password=password&amp;from=sender-number&amp;to=receiver-number&amp;
text=text+of+message+using+URL+encoding+as+necessary
</programlisting>

	(all of the above needs to be on one line, it's broken into
	several above so it will fit on the page). Thus, technically,
	you make a HTTP GET request. This means that all the information
	is stuffed into the URL. If you want to use this often via a
	browser, you probably want to make an HTML form for this.</para>

	<para>Username and password fields are spesified in
	configuration file, as <literal>sendsms-user</literal> groups.
	See configuration file syntax for more details.</para>

	
</sect1>

<sect1>
<title>Using the HTTP interface to send SMS messages with UDH field</title>

       <para>SMS messages can be sent with optional UDH (user data
       header) field. Add an 'udh=udh+data' to the URL requested. Note
       that a) automatic message splitting does not work and b) you
       should encode all bytes in UDH (and remaining text-field) for
       UDH to work correctly. An example URL is like this:

<programlisting>
http://localhost:13013/cgi-bin/sendsms?username=foo&amp;password=bar&amp;
from=123&amp;to=456&amp;udh=%3a%2f%04&amp;text=%20%00%60%7a%43
</programlisting>

	</para>
</sect1> 


<sect1>
<title>Using the HTTP administrative interface to control the gateway</title>

	<para>Kannel allows certain HTTP requests to monitor and control
	the gateway. These commands are sent to adminstration port
	defined in configuration file. Details can be found from file
	<filename>newbb.txt</filename></para>

	<para>Unlike in old version of the bearerbox, in Kannel
	version 0.9 and onward only password is used for adminstration
	authentication, so there is no more an username and password
	combination.</para>

</sect1>

</chapter>

<chapter id="bug-reporting">
<title>Getting help and reporting bugs</title>

	<para>This chapter explains where to find help with problems
	related to the gateway, and the preferred procedure for reporting
	bugs and sending corrections to them.</para>
	
	<para>The Kannel development mailing list is at
	devel@kannel.org.  To subscribe, send mail to <ulink
	url="mailto:devel-subscribe@kannel.org">devel-subscribe@kannel.org</ulink>.
	This is currently the best location for asking help and reporting
	bugs. Please include configuration file and version number.</para>
	
</chapter>

<appendix>
<title>Using the fake WAP sender</title>

	<para>This appendix explains how to use the fake WAP sender
	to test the gateway.</para>

</appendix>


<appendix>
<title>Using the fake SMS center</title>

	<para>This appendix explains how to use the fake SMS center
	to test the gateway.</para>

</appendix>


<appendix>
<title>Setting up a dial-up line</title>

	<para>This appendix explains how to set up a dial-up line for
	use with the gateway. It will probably be very short, and refer
	to existing documentation.</para>

</appendix>


</book>
